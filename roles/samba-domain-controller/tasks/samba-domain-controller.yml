---

# parando serviços se existirem

- name: verificar se os serviços existem
  stat: path=/etc/init.d/{{ item }}  
  loop:
     - smbd
     - nmbd
     - winbind
  register: service_status

# - name: parar os serviços
#   service:
#     name: '{{ item.item.stdout }}'
#     state: stopped 
#   loop: '{{ service_status.results }}'

- name: parar os serviços
  debug:
    msg: "{{ item }}"
  loop: '{{ service_status.results }}'


- name: verificar se os serviços smbd existe
  stat: path=/etc/init.d/smbd
  register: service_smbd_status

- name: parar serviço smbd
  service:
    name: smbd
    state: stopped
  when: service_smbd_status.stat.exists

- name: verificar se o serviço nmbd existe
  stat: path=/etc/init.d/nmbd
  register: service_nmbd_status

- name: parar serviço nmbd
  service:
    name: nmbd
    state: stopped
  when: service_nmbd_status.stat.exists

- name: verificar se o serviço winbind existe
  stat: path=/etc/init.d/winbind
  register: service_winbind_status    

- name: parar serviço winbind
  service:
    name: winbind
    state: stopped
  when: service_winbind_status.stat.exists

# removendo os arquivos de bando de dados se existirem

# remover o arquivo smb.conf existente

- name: criar backup do arquivo smb.conf
  copy:
    src: "/etc/samba/smb.conf"
    dest: "/etc/samba/smb.conf.original"
    remote_src: yes
    backup: yes         

- name: remover o arquivo smb.conf
  file:
    path: "/etc/samba/smb.conf"
    state: absent

# instalar

- name: instalar dependências de pacote necessárias 
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - acl
    - attr
    - autoconf
    - bind9utils
    - bison
    - build-essential
    - debhelper
    - dnsutils
    - docbook-xml
    - docbook-xsl
    - flex
    - gdb
    - libjansson-dev
    - libacl1-dev
    - libaio-dev
    - libarchive-dev
    - libattr1-dev
    - libblkid-dev
    - libbsd-dev
    - libcap-dev
    - libcups2-dev
    - libgnutls28-dev
    - libgpgme-dev
    - libjson-perl
    - libldap2-dev
    - libncurses5-dev
    - libpam0g-dev
    - libparse-yapp-perl
    - libpopt-dev
    - libreadline-dev
    - nettle-dev
    - perl
    - perl-modules
    - pkg-config
    - python-all-dev
    - python-crypto
    - python-dbg
    - python-dev
    - python-dnspython
    - python3-dnspython
    - python-gpgme
    - python3-gpgme
    - python-markdown
    - python3-markdown
    - python3-dev
    - xsltproc
    - zlib1g-dev
    - liblmdb-dev
    - lmdb-utils

- name: instalar samba
  apt:
    name: "samba"

- name: instalar restantes dos pacotes 
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - winbind
    - libpam-winbind
    - libnss-winbind
    - libpam-krb5
    - krb5-config
    - krb5-user
    - smbclient
    - ldap-utils

# provisionar samba dc

- name: provisionar samba dc
  command: samba-tool domain provision 
    --server-role=dc 
    --use-rfc2307 
    --dns-backend=BIND9_DLZ 
    --realm='{{samba_domain_controller_realm}}'
    --domain='{{samba_domain_controller_domain}}' 
    --adminpass='{{samba_domain_controller_admin_pass}}'

# configurando kerberos

# configurando back-end do dns do dc

# configurando rotas

# configurando rede

# configurando zona reversa

